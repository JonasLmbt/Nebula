<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nebula</title>

  <style>
  :root{
    --bg: rgba(20,20,28,0.78);
    --panel: rgba(255,255,255,0.06);
    --text: #e9e9f1;
    --muted: #9aa0aa;
    --accent: #6ee7ff;
    --good: #43d17f;
    --warn: #e0c14d;
    --bad: #e05a5a;
    --row: rgba(255,255,255,0.03);
    --row-hover: rgba(255,255,255,0.06);
    --menu: #1f2230;
    --shadow: 0 12px 30px rgba(0,0,0,0.35);
    --grip: 8px;
  }

  /* Reset / Base */
  html,body{margin:0;height:100%}
  body{
    background:var(--bg);
    color:var(--text);
    font:14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Arial, sans-serif;
    -webkit-font-smoothing:antialiased;
    user-select:none;
  }

  /* Topbar */
  .topbar{
    display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--panel);
    -webkit-app-region:drag;
  }
  .brand{font-weight:700;letter-spacing:0.2px;color:var(--accent)}
  .spacer{flex:1}
  .icon-btn,.search{ -webkit-app-region:no-drag }
  .icon-btn{
    width:30px;height:30px;display:grid;place-items:center;border-radius:8px;border:0;
    background:transparent;color:var(--text);cursor:pointer;
  }
  .icon-btn:hover{background:var(--row-hover)}
  .svg{width:16px;height:16px;display:block;opacity:.85}
  .icon-btn:hover .svg{opacity:1}
  .icon-btn--danger:hover{background:rgba(224,90,90,0.22);color:#ff6b6b}

  /* Search */
  .search{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--row);border-radius:12px}
  .search .svg{width:14px;height:14px;opacity:.6}
  .search input{background:transparent;border:0;outline:0;color:var(--text);width:280px;font-size:13px}

  /* Content / Table */
  .content{padding:10px 12px}
  .table-wrap{padding:8px}
  table{width:100%;border-collapse:collapse;table-layout:fixed;box-sizing:border-box}
  colgroup col.c-lvl{width:60px}
  colgroup col.c-name{width:180px}
  colgroup col.c-ws{width:60px}
  colgroup col.c-fkdr, colgroup col.c-wlr, colgroup col.c-bblr{width:88px}
  colgroup col.c-fk, colgroup col.c-wins{width:96px}
  colgroup col.c-actions{width:60px}

  thead th{
    text-align:left;font-weight:600;color:var(--muted);font-size:12px;padding:6px 8px;cursor:pointer;
    -webkit-app-region:no-drag;
  }
  th.metric-h, td.metric{ text-align:right;font-variant-numeric:tabular-nums; font-feature-settings:"tnum" 1,"lnum" 1 }
  tbody td{
    padding:10px 8px;border-top:1px solid rgba(255,255,255,0.06);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  tbody tr:hover{background:var(--row-hover)}
  .lvl{font-weight:600}
  .name{font-weight:600;color:#6bd3ff}
  .rank-tag{font-weight:700;margin-right:6px}
  .metric{text-align:right}
  .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}

  /* Row actions / menu */
  .actions{ text-align:right; position:relative; overflow:visible }
  .menu{
    position:absolute; right:8px; top:28px; background:var(--menu); border-radius:8px; box-shadow:var(--shadow);
    padding:6px; min-width:120px; display:none; z-index:10000;
  }
  .menu.open{display:block}
  .menu button{display:block;width:100%;text-align:left;background:transparent;border:0;color:var(--text);padding:8px 10px;border-radius:6px;cursor:pointer}
  .menu button:hover{background:var(--row-hover)}

  /* Resize grips */
  .grip{position:fixed;z-index:1000;-webkit-app-region:no-drag}
  .g-top{top:0;left:0;right:0;height:var(--grip);cursor:n-resize}
  .g-bottom{bottom:0;left:0;right:0;height:var(--grip);cursor:s-resize}
  .g-left{top:0;bottom:0;left:0;width:var(--grip);cursor:w-resize}
  .g-right{top:0;bottom:0;right:0;width:var(--grip);cursor:e-resize}
  .g-tl{top:0;left:0;width:var(--grip);height:var(--grip);cursor:nw-resize}
  .g-tr{top:0;right:0;width:var(--grip);height:var(--grip);cursor:ne-resize}
  .g-bl{bottom:0;left:0;width:var(--grip);height:var(--grip);cursor:sw-resize}
  .g-br{bottom:0;right:0;width:var(--grip);height:var(--grip);cursor:se-resize}

  /* Sidebar / Toolbar */
  .sidebar{
    position:fixed;left:0;top:0;bottom:0;width:260px;transform:translateX(-100%);
    transition:transform .22s cubic-bezier(.2,.9,.2,1);
    background:rgba(30,30,36,0.96);color:var(--text);box-shadow:var(--shadow);z-index:2000;
    -webkit-app-region:no-drag;display:flex;flex-direction:column;overflow:hidden;
  }
  .sidebar.open{transform:translateX(0)}
  .sidebar-inner{display:flex;flex-direction:column;height:100%;padding:14px}
  .nav{display:flex;flex-direction:column;gap:6px;margin-top:6px}
  .nav-item{
    display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;background:transparent;color:var(--text);
    border:0;text-align:left;cursor:pointer;-webkit-app-region:no-drag;font-weight:500;
  }
  .nav-item:hover{background:var(--row-hover)}
  .nav-item.active{background:rgba(255,255,255,0.04);font-weight:700}
  .nav-icon{width:22px;display:inline-block;text-align:center}
  .nav-label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .nav-sep{height:1px;background:rgba(255,255,255,0.03);margin:10px 0;border-radius:2px}
  .sidebar-footer{margin-top:auto;display:flex;flex-direction:column;gap:8px;padding-bottom:12px}
  .user-row{display:flex;align-items:center;gap:8px;margin-top:8px;color:var(--muted);padding-top:8px;border-top:1px solid rgba(255,255,255,0.02)}
  .user-icon{width:20px;display:inline-block;text-align:center}

  /* Buttons */
  .btn{border:0;padding:9px 10px;border-radius:6px;background:transparent;color:var(--text);cursor:pointer;-webkit-app-region:no-drag}
  .btn.primary{background:#ffb400;color:#111;font-weight:700}
  .btn.community{border:1px solid rgba(255,255,255,0.06);color:var(--accent)}

  /* Panels */
  .panel{display:none;padding:14px;height:calc(100vh - 50px);overflow-y:auto}
  .panel.active{display:block}

  /* Nicks */
  .nicks-list{background:var(--panel);border-radius:12px;overflow:hidden}
  .nick-row{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.04)}
  .nick-row:last-child{border:0}
  .nick-name{flex:1;margin-right:14px;font-weight:500}
  .nick-real{color:var(--muted);margin-right:14px}
  .delete-btn{opacity:.5;padding:6px;cursor:pointer;border:0;background:transparent;color:var(--text)}
  .delete-btn:hover{opacity:1}
  .add-btn{
    position:fixed;right:20px;bottom:20px;width:48px;height:48px;border-radius:24px;background:#00e676;color:#111;border:0;
    font-size:24px;cursor:pointer;box-shadow:0 4px 12px rgba(0,230,118,0.4)
  }
  .add-btn:hover{transform:scale(1.05)}

  .nick-indicator{font-size:12px;margin-left:6px;opacity:.7;cursor:help}

  /* Forms */
  .add-nick-form{background:var(--panel);border-radius:12px;padding:20px;margin-bottom:16px}
  .add-nick-form h2{margin:0 0 16px;font-size:18px;font-weight:600}
  .form-row{margin-bottom:12px}
  .form-label{display:flex;align-items:center;gap:10px;background:rgba(0,0,0,0.2);padding:8px 12px;border-radius:8px}
  .form-label .icon{opacity:.7}
  .form-label input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:14px;padding:4px 0}
  .form-submit{width:100%;background:#00e676;color:#111;border:0;padding:10px;border-radius:8px;font-weight:600;cursor:pointer;margin-top:4px}
  .form-submit:hover{opacity:.9}

  /* Settings */
  .settings-section{background:var(--panel);border-radius:8px;margin-top:16px;padding:20px}
  .settings-section h2{margin:0 0 20px;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px}
  .settings-row{margin-bottom:16px;display:flex;align-items:center}
  .settings-label{flex:0 0 120px;color:var(--muted)}
  .settings-select{background:rgba(0,0,0,0.2);color:var(--text);border:0;padding:8px 12px;border-radius:6px;min-width:200px}

  /* Columns list */
  .columns-list{display:flex;flex-direction:column;gap:4px}
  .column-row{display:flex;align-items:center;padding:8px 12px;background:rgba(0,0,0,0.2);border-radius:8px;gap:12px}
  .column-drag{cursor:move;color:var(--muted);font-size:16px}
  .column-toggle{flex:1;display:flex;align-items:center;gap:8px;cursor:pointer}
  .column-settings-btn{background:transparent;border:0;color:var(--text);opacity:.7;cursor:pointer;padding:4px 8px;border-radius:4px}
  .column-settings-btn:hover{opacity:1;background:rgba(255,255,255,0.05)}

  /* Modal / Color rules */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9000}
  .modal.open{display:flex;align-items:center;justify-content:center}
  .modal-content{background:var(--bg);border-radius:12px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
  .modal-header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:space-between}
  .modal-header h3{margin:0;font-size:16px;font-weight:600}
  .modal-close{background:transparent;border:0;color:var(--muted);font-size:24px;cursor:pointer}
  .modal-body{padding:20px}

  .color-rules{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
  .color-rule{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,0.2);padding:8px 12px;border-radius:6px}
  .rule-operator{width:60px}
  .rule-value{width:80px}
  .color-picker{display:flex;align-items:center;gap:8px;flex:1}
  .color-preview{width:20px;height:20px;border-radius:4px}
  .rule-delete{background:transparent;border:0;color:var(--muted);cursor:pointer;opacity:.7}
  .rule-delete:hover{opacity:1;color:var(--bad)}
  .add-rule-btn{width:100%;padding:8px;background:rgba(255,255,255,0.05);border:0;color:var(--text);border-radius:6px;cursor:pointer}
  .add-rule-btn:hover{background:rgba(255,255,255,0.08)}

  /* Settings navigation */
  .settings-nav{display:flex;flex-direction:column;gap:1px;background:var(--panel);border-radius:12px;overflow:hidden}
  .settings-nav-item{display:flex;align-items:center;gap:10px;padding:14px 16px;background:var(--panel);border:0;color:var(--text);font-size:14px;text-align:left;cursor:pointer}
  .settings-nav-item:hover{background:rgba(255,255,255,0.03)}
  .settings-nav-item.active{background:rgba(255,255,255,0.04)}
  .settings-nav-item .nav-icon{width:20px;text-align:center;font-size:16px}
  .settings-nav-item .nav-label{flex:1;font-weight:500}
  .nav-arrow{font-size:12px;opacity:.5;margin-left:4px;transition:transform .2s}
  .settings-nav-item.active .nav-arrow{transform:rotate(180deg)}
  .nav-item.expanded .nav-arrow{transform:rotate(180deg)}
  .settings-submenu{display:none;margin-left:24px;margin-top:4px;border-left:1px solid rgba(255,255,255,0.1)}
  .settings-submenu.expanded{display:block}
  .nav-item.sub-item{padding:8px 12px;font-size:13px}
  .nav-item.sub-item .nav-icon{font-size:14px}
  .nav-item.sub-item[data-settings="columns"].active{color:#00e676}
  .settings-nav-item[data-settings="columns"].active{color:#00e676}
  </style>
</head>

<body>
  <div class="topbar">
    <button id="menuBtn" class="icon-btn" aria-label="Menu" title="Menu">
      <svg class="svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/>
      </svg>
    </button>
    <div class="brand">Nebula</div>
    <div class="spacer"></div>

    <!-- Refresh -->
    <button id="refresh" class="icon-btn" aria-label="Refresh" title="Refresh">
      <svg class="svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M17.65 6.35A7.95 7.95 0 0 0 12 4a8 8 0 1 0 7.75 10h-2.1A6 6 0 1 1 12 6c1.64 0 3.13.66 4.22 1.73L13 11h7V4l-2.35 2.35z"/>
      </svg>
    </button>

    <!-- Clear all -->
    <button id="clearAll" class="icon-btn" aria-label="Clear all players" title="Clear all players">
      <svg class="svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M9 3h6v2h5v2H4V5h5V3zm1 6h2v9h-2V9zm4 0h2v9h-2V9z"/>
      </svg>
    </button>

    <!-- Search -->
    <div class="search">
      <svg class="svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20 15.5 14zM9.5 14A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/>
      </svg>
      <input id="playerInput" placeholder="Search player(s), comma-separated" />
    </div>

    <!-- Minimize -->
    <button id="minBtn" class="icon-btn" aria-label="Minimize" title="Minimize">
      <svg class="svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 13H5v-2h14v2z"/>
      </svg>
    </button>

    <!-- Close -->
    <button id="closeBtn" class="icon-btn icon-btn--danger" aria-label="Close" title="Close">
      <svg class="svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.41L10.59 13.41 4.29 19.7 2.88 18.29 9.17 12 2.88 5.71 4.29 4.3 10.59 10.59 16.89 4.3z"/>
      </svg>
    </button>


  </div>

  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <div class="sidebar-inner">
      <nav class="nav">
        <button class="nav-item active" data-panel="home">
          <span class="nav-icon">üè†</span>
          <span class="nav-label">Home</span>
        </button>

        <button class="nav-item" data-panel="nicks">
          <span class="nav-icon">üë•</span>
          <span class="nav-label">Nicks</span>
        </button>

        <div class="nav-sep"></div>

        <button class="nav-item" data-panel="settings">
          <span class="nav-icon">‚öôÔ∏è</span>
          <span class="nav-label">Settings</span>
          <span class="nav-arrow">‚ñæ</span>
        </button>

        <!-- Untermen√º f√ºr Settings -->
        <div class="settings-submenu">
          <button class="nav-item sub-item" data-panel="settings" data-settings="basic">
            <span class="nav-icon">üìå</span>
            <span class="nav-label">Basic</span>
          </button>
          
          <button class="nav-item sub-item" data-panel="settings" data-settings="advanced">
            <span class="nav-icon">üîß</span>
            <span class="nav-label">Advanced</span>
          </button>
          
          <button class="nav-item sub-item" data-panel="settings" data-settings="appearance">
            <span class="nav-icon">üé®</span>
            <span class="nav-label">Appearance</span>
          </button>
          
          <button class="nav-item sub-item" data-panel="settings" data-settings="sources">
            <span class="nav-icon">üîó</span>
            <span class="nav-label">Sources</span>
          </button>
          
          <button class="nav-item sub-item" data-panel="settings" data-settings="columns">
            <span class="nav-icon">üìä</span>
            <span class="nav-label">Columns</span>
          </button>
          
          <button class="nav-item sub-item" data-panel="settings" data-settings="antisniper">
            <span class="nav-icon">üéØ</span>
            <span class="nav-label">Anti-Sniper</span>
          </button>
          
          <button class="nav-item sub-item" data-panel="settings" data-settings="keyboard">
            <span class="nav-icon">‚å®Ô∏è</span>
            <span class="nav-label">Keyboard Shortcuts</span>
          </button>
          
          <button class="nav-item sub-item" data-panel="settings" data-settings="notifications">
            <span class="nav-icon">üîî</span>
            <span class="nav-label">Notifications</span>
          </button>
        </div>
      
      <div class="nav-sep"></div>

      <div class="sidebar-footer">
        <div class="user-row">
          <span class="user-icon">üë§</span>
          <span class="user-name">username</span>
        </div>
      </div>
    </div>
  </aside>

  <div class="content">
    <!-- Home Panel -->
    <div class="panel" id="panel-home">
      <div class="table-wrap">
        <table id="table">
          <colgroup>
            <col class="c-lvl"><col class="c-name"><col class="c-ws">
            <col class="c-fkdr"><col class="c-wlr"><col class="c-bblr">
            <col class="c-fk"><col class="c-wins"><col class="c-actions">
          </colgroup>
          <thead>
            <tr>
              <th data-key="level">Lvl</th>
              <th data-key="name">Name</th>
              <th class="metric-h">WS</th>
              <th class="metric-h">FKDR</th>
              <th class="metric-h">WLR</th>
              <th class="metric-h">BBLR</th>
              <th class="metric-h">F. Kills</th>
              <th class="metric-h">Wins</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <!-- Nicks Panel -->
    <div class="panel" id="panel-nicks">
      <!-- Add Nick Form -->
      <div class="add-nick-form" id="addNickForm" style="display: none;">
        <h2>Add Nick</h2>
        <div class="form-row">
          <label class="form-label">
            <span class="icon">üë§</span>
            <input type="text" id="nickInput" placeholder="Nick" />
          </label>
        </div>
        <div class="form-row">
          <label class="form-label">
            <span class="icon">üéØ</span>
            <input type="text" id="realNameInput" placeholder="Name" />
          </label>
        </div>
        <button class="form-submit" id="saveNickBtn">ADD</button>
      </div>

      <!-- Nicks List -->
      <div class="nicks-list" id="nicksList">
        <!-- Nicks werden hier per JS eingef√ºgt -->
      </div>
      <button class="add-btn" id="addNickBtn" title="Add nick">+</button>
    </div>

    <!-- Settings Panel -->
    <div class="panel" id="panel-settings">
      <div class="settings-section">
        <h2>
          <span class="settings-icon">‚öôÔ∏è</span>
          Columns Settings
        </h2>
        
        <!-- Game Select -->
        <div class="settings-row">
          <label class="settings-label">Game</label>
          <select class="settings-select" id="gameSelect">
            <option value="bedwars">Bed Wars</option>
          </select>
        </div>

        <!-- Columns List -->
        <div class="columns-list" id="columnsList">
          <!-- Jede Spalte als eigene Zeile -->
          <div class="column-row" data-column="level">
            <div class="column-drag">‚ãÆ‚ãÆ</div>
            <label class="column-toggle">
              <input type="checkbox" checked data-column="level">
              <span class="column-name">Level</span>
            </label>
            <button class="column-settings-btn" title="Color settings">üé®</button>
          </div>
          <!-- Weitere Spalten werden per JS hinzugef√ºgt -->
        </div>
      </div>

      <!-- Color Rules Modal -->
      <div class="modal" id="colorRulesModal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Color Rules: <span id="colorRuleTitle"></span></h3>
            <button class="modal-close">√ó</button>
          </div>
          <div class="modal-body">
            <div class="color-rules" id="colorRulesList">
              <!-- Regeln werden per JS eingef√ºgt -->
              <div class="color-rule">
                <select class="rule-operator">
                  <option value=">=">‚â•</option>
                  <option value="<"><</option>
                </select>
                <input type="number" class="rule-value" step="0.1">
                <div class="color-picker">
                  <div class="color-preview"></div>
                  <select class="color-select">
                    <option value="good">Good (Green)</option>
                    <option value="warn">Warning (Yellow)</option>
                    <option value="bad">Danger (Red)</option>
                  </select>
                </div>
                <button class="rule-delete">√ó</button>
              </div>
            </div>
            <button class="add-rule-btn">+ Add Rule</button>
          </div>
        </div>
      </div>
    </div>

  <!-- invisible grips -->
  <div class="grip g-top" data-edge="top"></div>
  <div class="grip g-bottom" data-edge="bottom"></div>
  <div class="grip g-left" data-edge="left"></div>
  <div class="grip g-right" data-edge="right"></div>
  <div class="grip g-tl" data-edge="top-left"></div>
  <div class="grip g-tr" data-edge="top-right"></div>
  <div class="grip g-bl" data-edge="bottom-left"></div>
  <div class="grip g-br" data-edge="bottom-right"></div>

  <script>
    const { ipcRenderer } = require("electron");
    const rows = document.getElementById("rows");
    const input = document.getElementById("playerInput");
    let queue = [];

    // Track currently displayed players to avoid duplicate fetches
    const displayedPlayers = new Set();

    // Fetch stats for a single player and update UI
    async function fetchPlayerStats(name) {
      if (displayedPlayers.has(name.toLowerCase())) return; // Skip if already displayed
      
      const realName = getRealName(name);
      const wasNick = isNick(name);
      
      const res = await ipcRenderer.invoke("bedwars:stats", realName);
      if (res.error) return;

      displayedPlayers.add(name.toLowerCase());
      
      // Use the same ordered cells logic as before
      const orderedCells = [
        `<td class="lvl ${getColorForValue('level', res.level)}">${fmt(res.level)}</td>`,
        `<td class="name">
          ${res.rankTag ? `<span class="rank-tag" style="color:${esc(res.rankColor || '#ffffff')};font-weight:700;margin-right:6px">${esc(res.rankTag)}</span>` : ''}
          ${esc(res.name)}
          ${wasNick ? `<span class="nick-indicator" title="Nick: ${esc(name)}">üëª</span>` : ''}
        </td>`,
        `<td class="metric">${fmt(res.ws)}</td>`,
        `<td class="metric ${getColorForValue('fkdr', res.fkdr)}">${fmt(res.fkdr)}</td>`,
        `<td class="metric ${getColorForValue('wlr', res.wlr)}">${fmt(res.wlr)}</td>`,
        `<td class="metric ${getColorForValue('bblr', res.bblr)}">${fmt(res.bblr)}</td>`,
        `<td class="metric">${fmt(res.fk)}</td>`,
        `<td class="metric">${fmt(res.wins)}</td>`
      ].join('');

      rows.insertAdjacentHTML("beforeend", `
        <tr data-name="${escAttr(res.name)}">
          ${orderedCells}
          <td class="actions">
            <button class="icon-btn row-menu-btn">‚ãÆ</button>
            <div class="menu">
              <button class="remove-btn">Remove</button>
            </div>
          </td>
        </tr>
      `);

      // Rebind menu events for the new row
      bindMenus();
    }

    // Remove a player from the displayed list
    function removePlayer(name) {
      const row = rows.querySelector(`tr[data-name="${escAttr(name)}"]`);
      if (row) {
        row.remove();
        displayedPlayers.delete(name.toLowerCase());
      }
    }

    // Handle incoming player lists (from chat logger)
    ipcRenderer.on('chat:players', (_e, newPlayers) => {
      try {
        if (!Array.isArray(newPlayers)) return;

        // Get currently displayed players
        const currentPlayers = Array.from(displayedPlayers);
        
        // Remove players that are no longer in the list
        currentPlayers.forEach(displayed => {
          if (!newPlayers.some(p => p.toLowerCase() === displayed.toLowerCase())) {
            removePlayer(displayed);
          }
        });

        // Add new players that aren't displayed yet
        newPlayers.forEach(player => {
          if (!player || typeof player !== 'string') return;
          fetchPlayerStats(player); // Will skip if already displayed
        });

      } catch (err) {
        console.error('Error handling chat:players', err);
      }
    });

    // Party members handling (similar to players but always add)
    ipcRenderer.on('chat:party', (_e, members) => {
      try {
        if (!Array.isArray(members)) return;
        members.forEach(member => {
          if (!member || typeof member !== 'string') return;
          fetchPlayerStats(member);
        });
      } catch (err) {
        console.error('Error handling chat:party', err);
      }
    });

    function esc(s) { return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
    function escAttr(s) { return esc(s).replace(/"/g, "&quot;"); }
    function fmt(n) { return (n == null || isNaN(n)) ? "‚Äî" : n; }
    
    // Nick management
    let nicks = JSON.parse(localStorage.getItem('nicks') || '[]');

    function saveNicks() {
      localStorage.setItem('nicks', JSON.stringify(nicks));
    }

    function getRealName(name) {
      const nick = nicks.find(n => n.nick.toLowerCase() === name.toLowerCase());
      return nick ? nick.real : name;
    }

    function isNick(name) {
      return nicks.some(n => n.nick.toLowerCase() === name.toLowerCase());
    }

    // Nicks Panel UI
    function renderNicks() {
      const list = document.getElementById('nicksList');
      if (!list) return;

      list.innerHTML = nicks.map(({nick, real}) => `
        <div class="nick-row" data-nick="${escAttr(nick)}">
          <span class="nick-name">${esc(nick)}</span>
          <span class="nick-real">${esc(real)}</span>
          <button class="delete-btn" title="Remove nick">‚úï</button>
        </div>
      `).join('');

      list.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          const row = e.target.closest('.nick-row');
          const nick = row.getAttribute('data-nick');
          nicks = nicks.filter(n => n.nick !== nick);
          saveNicks();
          renderNicks();
        });
      });
    }

    // Nick form handling
    const addNickBtn = document.getElementById('addNickBtn');
    const addNickForm = document.getElementById('addNickForm');
    const nickInput = document.getElementById('nickInput');
    const realNameInput = document.getElementById('realNameInput');
    const saveNickBtn = document.getElementById('saveNickBtn');

    // Show/hide form when + button is clicked
    addNickBtn?.addEventListener('click', () => {
      addNickForm.style.display = 'block';
      nickInput.focus();
    });

    // Save nick when form is submitted
    saveNickBtn?.addEventListener('click', () => {
      const nick = nickInput.value.trim();
      const real = realNameInput.value.trim();
      
      if (nick && real) {
        if (!nicks.some(n => n.nick.toLowerCase() === nick.toLowerCase())) {
          nicks.push({nick, real});
          saveNicks();
          renderNicks();
          
          // Reset form
          nickInput.value = '';
          realNameInput.value = '';
          addNickForm.style.display = 'none';
        }
      }
    });

    // Enter in second input also submits
    realNameInput?.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        saveNickBtn.click();
      }
    });

    // Escape closes form
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && addNickForm.style.display === 'block') {
        addNickForm.style.display = 'none';
        nickInput.value = '';
        realNameInput.value = '';
      }
    });

    async function fetchAll() {
      rows.innerHTML = "";
      for (const inputName of queue) {
        // Check if it's a nick and get real name
        const realName = getRealName(inputName);
        const wasNick = isNick(inputName);
        
        const res = await ipcRenderer.invoke("bedwars:stats", realName);
        if (res.error) continue;

        const fkdrC = res.fkdr > 3 ? "good" : res.fkdr > 1 ? "warn" : "bad";
        const wlrC = res.wlr > 3 ? "good" : res.wlr > 1 ? "warn" : "bad";
        const lvlC = res.level > 300 ? "good" : res.level > 100 ? "warn" : "bad";

        rows.insertAdjacentHTML("beforeend", `
          <tr data-name="${escAttr(res.name)}">
            <td class="lvl ${lvlC}">${res.level ?? 0}</td>
            <td class="name">
              ${esc(res.name)}
              ${wasNick ? `<span class="nick-indicator" title="Nick: ${esc(inputName)}">üëª</span>` : ''}
            </td>
            <td class="metric">${fmt(res.ws)}</td>
            <td class="metric ${fkdrC}">${fmt(res.fkdr)}</td>
            <td class="metric ${wlrC}">${fmt(res.wlr)}</td>
            <td class="metric">${fmt(res.bblr)}</td>
            <td class="metric">${fmt(res.fk)}</td>
            <td class="metric">${fmt(res.wins)}</td>
            <td class="actions">
              <button class="icon-btn row-menu-btn">‚ãÆ</button>
              <div class="menu">
                <button class="remove-btn">Remove</button>
              </div>
            </td>
          </tr>
        `);
      }
      bindMenus();
    }

    function bindMenus() {
      const btns = Array.from(document.querySelectorAll(".row-menu-btn"));
      const removes = Array.from(document.querySelectorAll(".remove-btn"));

      btns.forEach(btn => {
        btn.addEventListener("click", e => {
          e.stopPropagation();
          closeAllMenus();
          const menu = btn.nextElementSibling;
          menu.classList.add("open");
        });
      });

      removes.forEach(b => {
        b.addEventListener("click", e => {
          e.stopPropagation();
          const tr = b.closest("tr");
          const name = tr.getAttribute("data-name");
          queue = queue.filter(n => n.toLowerCase() !== name.toLowerCase());
          fetchAll();
        });
      });

      document.addEventListener("click", closeAllMenus);
    }

    function closeAllMenus() {
      document.querySelectorAll(".menu.open").forEach(m => m.classList.remove("open"));
    }

    input.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        const names = input.value.split(",").map(s => s.trim()).filter(Boolean);
        queue.push(...names);
        input.value = "";
        fetchAll();
      }
    });

    document.getElementById("clearAll").addEventListener("click", () => {
      queue = [];
      rows.innerHTML = "";
    });

    document.getElementById("refresh").addEventListener("click", fetchAll);
    document.getElementById("minBtn").addEventListener("click", () => ipcRenderer.send("window:minimize"));
    document.getElementById("closeBtn").addEventListener("click", () => ipcRenderer.send("window:close"));

    // --- resize grips
    let resizing = null;
    function onDown(e) {
      const edge = e.target.getAttribute("data-edge");
      if (!edge) return;
      resizing = { edge, startX: e.screenX, startY: e.screenY };
      window.addEventListener("mousemove", onMove);
      window.addEventListener("mouseup", onUp, { once: true });
    }
    function onMove(e) {
      if (!resizing) return;
      const dx = e.screenX - resizing.startX;
      const dy = e.screenY - resizing.startY;
      ipcRenderer.invoke("window:resize", { edge: resizing.edge, dx, dy });
      resizing.startX = e.screenX;
      resizing.startY = e.screenY;
    }
    function onUp() {
      resizing = null;
      window.removeEventListener("mousemove", onMove);
    }

    // Sidebar toggle + interactions
    const menuBtn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');

    if (menuBtn && sidebar) {
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const opened = sidebar.classList.toggle('open');
        sidebar.setAttribute('aria-hidden', String(!opened));
      });

      // Close sidebar when clicking outside
      document.addEventListener('click', (e) => {
        if (!sidebar.classList.contains('open')) return;
        if (e.target.closest && (e.target.closest('#sidebar') || e.target.closest('#menuBtn'))) return;
        sidebar.classList.remove('open');
        sidebar.setAttribute('aria-hidden', 'true');
      });

      // Close with Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && sidebar.classList.contains('open')) {
          sidebar.classList.remove('open');
          sidebar.setAttribute('aria-hidden', 'true');
        }
      });

      // Nav item activation (no panel switching implemented yet)
      document.querySelectorAll('.nav-item').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          // Optionally: toggle content panels here based on data-panel attribute
        });
      });
    }

    document.querySelectorAll(".grip").forEach(g => g.addEventListener("mousedown", onDown));
    
    // --- Panel switching
    function showPanel(id) {
      document.querySelectorAll('.panel').forEach(p => {
        p.classList.toggle('active', p.id === `panel-${id}`);
      });
      localStorage.setItem('activePanel', id);

      // Update nav items
      document.querySelectorAll('.nav-item').forEach(b => 
        b.classList.toggle('active', b.getAttribute('data-panel') === id)
      );
    }

    // Update nav item click handler
    document.querySelectorAll('.nav-item').forEach(btn => {
      btn.addEventListener('click', () => {
        const panel = btn.getAttribute('data-panel');
        showPanel(panel);
      });
    });

    // Immer mit Home starten
    showPanel('home');

    // Add new nick
    document.getElementById('addNickBtn')?.addEventListener('click', () => {
      const nick = prompt('Enter nick:');
      if (!nick) return;
      const real = prompt('Enter real name:');
      if (!real) return;

      if (!nicks.some(n => n.nick === nick)) {
        nicks.push({nick, real});
        saveNicks();
        renderNicks();
      }
    });

    // Initial render
    renderNicks();

    // Column definitions
    const COLUMNS = {
      level: { name: 'Level', type: 'number', colorRules: true },
      name: { name: 'Name', type: 'text' },
      ws: { name: 'Win Streak', type: 'number', colorRules: true },
      fkdr: { name: 'Final K/D Ratio', type: 'number', colorRules: true },
      wlr: { name: 'Win/Loss Ratio', type: 'number', colorRules: true },
      bblr: { name: 'Bed Break/Loss Ratio', type: 'number', colorRules: true },
      fk: { name: 'Final Kills', type: 'number' },
      wins: { name: 'Wins', type: 'number' }
    };

    // Load/save column settings
    let columnSettings = JSON.parse(localStorage.getItem('columnSettings') || JSON.stringify({
      visible: Object.keys(COLUMNS),
      order: Object.keys(COLUMNS),
      colorRules: {
        level: [
          { op: '>=', value: 300, color: 'good' },
          { op: '>=', value: 100, color: 'warn' }
        ],
        fkdr: [
          { op: '>=', value: 3, color: 'bad' },
          { op: '>=', value: 1, color: 'warn' }
        ],
        wlr: [
          { op: '>=', value: 3, color: 'bad' },
          { op: '>=', value: 1, color: 'warn' }
        ]
      }
    }));

    function saveColumnSettings() {
      localStorage.setItem('columnSettings', JSON.stringify(columnSettings));
      renderTable(); // Re-render main table with new settings
    }

    // Render columns list in settings
    function renderColumnsList() {
      const list = document.getElementById('columnsList');
      if (!list) return;

      list.innerHTML = columnSettings.order.map(col => `
        <div class="column-row" data-column="${col}">
          <div class="column-drag">‚ãÆ‚ãÆ</div>
          <label class="column-toggle">
            <input type="checkbox" ${columnSettings.visible.includes(col) ? 'checked' : ''} data-column="${col}">
            <span class="column-name">${COLUMNS[col].name}</span>
          </label>
          ${COLUMNS[col].colorRules ? `
            <button class="column-settings-btn" data-column="${col}" title="Color rules">üé®</button>
          ` : ''}
        </div>
      `).join('');

      // Bind events
      list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', e => {
          const col = e.target.dataset.column;
          if (e.target.checked) {
            columnSettings.visible.push(col);
          } else {
            columnSettings.visible = columnSettings.visible.filter(c => c !== col);
          }
          saveColumnSettings();
        });
      });

      list.querySelectorAll('.column-settings-btn').forEach(btn => {
        btn.addEventListener('click', () => showColorRules(btn.dataset.column));
      });
    }

    // Color rules modal
    function showColorRules(column) {
      const modal = document.getElementById('colorRulesModal');
      const title = document.getElementById('colorRuleTitle');
      const rulesList = document.getElementById('colorRulesList');
      
      title.textContent = COLUMNS[column].name;
      modal.classList.add('open');

      function renderRules() {
        const rules = columnSettings.colorRules[column] || [];
        rulesList.innerHTML = rules.map((rule, i) => `
          <div class="color-rule" data-index="${i}">
            <select class="rule-operator">
              <option value=">=" ${rule.op === '>=' ? 'selected' : ''}>‚â•</option>
              <option value="<" ${rule.op === '<' ? 'selected' : ''}>Ôºú</option>
            </select>
            <input type="number" class="rule-value" value="${rule.value}" step="0.1">
            <div class="color-picker">
              <div class="color-preview" style="background: var(--${rule.color})"></div>
              <select class="color-select">
                <option value="good" ${rule.color === 'good' ? 'selected' : ''}>Good (Green)</option>
                <option value="warn" ${rule.color === 'warn' ? 'selected' : ''}>Warning (Yellow)</option>
                <option value="bad" ${rule.color === 'bad' ? 'selected' : ''}>Danger (Red)</option>
              </select>
            </div>
            <button class="rule-delete">√ó</button>
          </div>
        `).join('');

        // Bind rule events
        rulesList.querySelectorAll('.color-rule').forEach(rule => {
          const i = parseInt(rule.dataset.index);
          
          rule.querySelector('.rule-operator').addEventListener('change', e => {
            columnSettings.colorRules[column][i].op = e.target.value;
            saveColumnSettings();
          });

          rule.querySelector('.rule-value').addEventListener('change', e => {
            columnSettings.colorRules[column][i].value = parseFloat(e.target.value);
            saveColumnSettings();
          });

          rule.querySelector('.color-select').addEventListener('change', e => {
            columnSettings.colorRules[column][i].color = e.target.value;
            rule.querySelector('.color-preview').style.background = `var(--${e.target.value})`;
            saveColumnSettings();
          });

          rule.querySelector('.rule-delete').addEventListener('click', () => {
            columnSettings.colorRules[column].splice(i, 1);
            saveColumnSettings();
            renderRules();
          });
        });
      }

      renderRules();

      // Add rule button
      document.querySelector('.add-rule-btn').onclick = () => {
        if (!columnSettings.colorRules[column]) {
          columnSettings.colorRules[column] = [];
        }
        columnSettings.colorRules[column].push({
          op: '>=',
          value: 0,
          color: 'good'
        });
        saveColumnSettings();
        renderRules();
      };

      // Close modal
      modal.querySelector('.modal-close').onclick = () => {
        modal.classList.remove('open');
      };
    }

    // Initialize settings
    renderColumnsList();

    // Update table rendering to use column settings
    function getColorForValue(column, value) {
      const rules = columnSettings.colorRules[column];
      if (!rules) return '';

      for (const rule of rules) {
        if (rule.op === '>=' && value >= rule.value) return rule.color;
        if (rule.op === '<' && value < rule.value) return rule.color;
      }
      return '';
    }

    // Update fetchAll to use column settings
    async function fetchAll() {
      rows.innerHTML = "";
      for (const inputName of queue) {
        const realName = getRealName(inputName);
        const wasNick = isNick(inputName);
        
        const res = await ipcRenderer.invoke("bedwars:stats", realName);
        if (res.error) continue;

        // Ensure columns are in correct order matching the table head
        const orderedCells = [
          `<td class="lvl ${getColorForValue('level', res.level)}">${fmt(res.level)}</td>`,
          `<td class="name">
            ${esc(res.name)}
            ${wasNick ? `<span class="nick-indicator" title="Nick: ${esc(inputName)}">üëª</span>` : ''}
          </td>`,
          `<td class="metric">${fmt(res.ws)}</td>`,
          `<td class="metric ${getColorForValue('fkdr', res.fkdr)}">${fmt(res.fkdr)}</td>`,
          `<td class="metric ${getColorForValue('wlr', res.wlr)}">${fmt(res.wlr)}</td>`,
          `<td class="metric ${getColorForValue('bblr', res.bblr)}">${fmt(res.bblr)}</td>`,
          `<td class="metric">${fmt(res.fk)}</td>`,
          `<td class="metric">${fmt(res.wins)}</td>`
        ].join('');

        rows.insertAdjacentHTML("beforeend", `
          <tr data-name="${escAttr(res.name)}">
            ${orderedCells}
            <td class="actions">
              <button class="icon-btn row-menu-btn">‚ãÆ</button>
              <div class="menu">
                <button class="remove-btn">Remove</button>
              </div>
            </td>
          </tr>
        `);
      }
      bindMenus();
    }

    // Settings submenu toggle
    const settingsBtn = document.querySelector('.nav-item[data-panel="settings"]');
    const settingsSubmenu = document.querySelector('.settings-submenu');

    // Toggle submenu when settings is clicked
    settingsBtn?.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent panel switch
      settingsBtn.classList.toggle('expanded');
      settingsSubmenu.classList.toggle('expanded');
      
      // Save state
      localStorage.setItem('settingsExpanded', 
        settingsBtn.classList.contains('expanded'));
    });

    // Handle settings section clicks
    document.querySelectorAll('.nav-item.sub-item').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const section = btn.getAttribute('data-settings');
        
        // Update active states
        document.querySelectorAll('.nav-item.sub-item').forEach(b => 
          b.classList.toggle('active', b === btn)
        );
        
        // Show settings panel and active section
        showPanel('settings');
        showSettingsSection(section);
        
        // Save active section
        localStorage.setItem('activeSettingsSection', section);
      });
    });

    // Show specific settings section
    function showSettingsSection(section) {
      document.querySelectorAll('.settings-content').forEach(content => {
        content.classList.toggle('active', 
          content.getAttribute('data-section') === section);
      });
    }

    // Restore settings state on load
    const settingsExpanded = localStorage.getItem('settingsExpanded') === 'true';
    if (settingsExpanded) {
      settingsBtn.classList.add('expanded');
      settingsSubmenu.classList.add('expanded');
    }

    // Restore active settings section
    const activeSection = localStorage.getItem('activeSettingsSection') || 'columns';
    const activeBtn = document.querySelector(
      `.nav-item.sub-item[data-settings="${activeSection}"]`
    );
    if (activeBtn) {
      activeBtn.classList.add('active');
      if (document.querySelector('.panel#panel-settings.active')) {
        showSettingsSection(activeSection);
      }
    }
  </script>
</body>
</html>
